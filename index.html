<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lecture 12</title>
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/white.css">
    <link rel="stylesheet" href="css/theme/custom.css">
    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/github-gist.css">
    <!-- Printing and PDF exports -->
    <script>
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
    document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>

<body>
    <div class="reveal" style="background-color: #fff;">
        <div class="slides">
            <section data-background-video="bgm.mp4" data-background-video-loop data-background-video-muted style="text-align: left;">
                <h2 style="color: white">Python Programming</h2>
                <h5 style="color: white">Lecture 12 Downloading Data, API</h5>
            </section>
            <section>
                <section data-background="#2980b9" style="color: white">
                    <h2 style="color: white">12.1 Downloading Data (2)</h2>
                </section>
                <section>
                    <p><b>.JSON</b></p>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>

import json

filename = 'btc_close_2017.json'
with open(filename) as f:
    btc_data = json.load(f)  

for btc_dict in btc_data:
    date = btc_dict['date']
    month = int(btc_dict['month'])
    week = int(btc_dict['week'])
    weekday = btc_dict['weekday']
    close = int(float(btc_dict['close']))  
    print("{} is month {} week {}, {}, the close price is {} RMB".format(
        date, month, week, weekday, close))
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
2017-01-01 is month 1 week 52, Sunday, the close price is 6928 RMB
2017-01-02 is month 1 week 1, Monday, the close price is 7070 RMB
2017-01-03 is month 1 week 1, Tuesday, the close price is 7175 RMB
2017-01-04 is month 1 week 1, Wednesday, the close price is 7835 RMB
2017-01-05 is month 1 week 1, Thursday, the close price is 6928 RMB
...
</code></pre>
                    </div>
                </section>
                <section>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>


line_chart = pygal.Line(x_label_rotation=20, show_minor_x_labels=False) 
line_chart.title = '收盘价（¥）'
line_chart.x_labels = dates
N = 20  # X-axis shows the date for every 20 days 
line_chart.x_labels_major = dates[::N]
line_chart.add('收盘价', close)
line_chart.render_to_file('收盘价折线图（¥）.svg')
</code></pre>
                    </div>
                    <div class="fragment"><img data-src="close_price.svg" style="height: 350pt"></div>
                </section>
                <section>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
line_chart = pygal.Line(x_label_rotation=20, show_minor_x_labels=False)
line_chart.title = '收盘价对数变换（¥）'
line_chart.x_labels = dates
N = 20
line_chart.x_labels_major = dates[::N]
<mark>close_log = [math.log10(xx) for xx in close]</mark>
<mark>line_chart.add('log收盘价', close_log)</mark>
line_chart.render_to_file('收盘价对数变换折线图（¥）.svg')
</code></pre>
                    </div>
                    <div class="fragment"><img data-src="close_price_log.svg" style="height: 350pt"></div>
                </section>
                <section>
                    <p><b>itertools</b></p>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
import itertools

nums = itertools.count(0,2)
for i in nums:
    if i > 6:
        break
    print(i, end = " ")
#output
0 2 4 6 
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
import itertools

cycle_strings = itertools.cycle('ABC')
i = 1
for string in cycle_strings:
    if i == 7:
        break
    print(i, string)
    i += 1
#output
1 A
2 B
3 C
4 A
5 B
6 C
</code></pre>
                    </div>
                </section>
                <section>
                    <ul>
                        <li class="fragment">
                            <p>We have learned <b>generator</b>.(next(), for)</p>
                        </li>
                        <div class="fragment">
                            <pre><code class="line-numbers" data-trim contenteditable data-noescape>
g = (x * x for x in range(10))

def fib(max):
    n, a, b = 0, 0, 1
    while n < max:
        yield b
        a, b = b, a + b
        n = n + 1
    return 'done'
</code></pre>
                        </div>
                        <li class="fragment">
                            <p><b>Iterator</b> is a more general concept: any object whose class has a next method (__next__ in Python 3) and an __iter__ method.</p>
                        </li>
                        <li class="fragment">
                            <p>Every generator is an iterator, but not vice versa.</p>
                        </li>
                        <li class="fragment">
                            <p><b>An iterator can only be traversed once.</b></p>
                        </li>
                        <li class="fragment">
                            <p>Iterator and iterable are two different concepts</p>
                        </li>
                    </ul>
                </section>
                <section>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
import itertools

for item in itertools.repeat('hello world', 3):
    print(item)

hello world
hello world
hello world
</code></pre>
                    </div>
                    <p class="fragment"><b>groupby()</b></p>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
from itertools import groupby

for key, value_iter in groupby('aaabbbaaccd'):
    print(key, ':', list(value_iter))

a : ['a', 'a', 'a']
b : ['b', 'b', 'b']
a : ['a', 'a']
c : ['c', 'c']
d : ['d']
</code></pre>
                    </div>
                </section>
                <section>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
from itertools import groupby

data = ['a', 'bb', 'ccc', 'dd', 'eee', 'f']
for key, value_iter in groupby(data, len):  
    print(key, ':', list(value_iter))

1 : ['a']
2 : ['bb']
3 : ['ccc']
2 : ['dd']
3 : ['eee']
1 : ['f']
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
from itertools import groupby

data = ['a', 'bb', 'cc', 'ddd', 'eee', 'f']
for key, value_iter in groupby(data, len):  
    print(key, ':', list(value_iter))

1 : ['a']
2 : ['bb', 'cc']
3 : ['ddd', 'eee']
1 : ['f']
</code></pre>
                    </div>
                </section>
                <section>
                    <p><b>zip()</b></p>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
>>> a = [1,2,3]
>>> b = [4,5,6]
>>> c = [4,5,6,7,8]
>>> zipped = zip(a,b)
>>> zipped
<zip object at 0x02B01B48> #返回的是一个对象(iterator)
>>> list(zipped)
[(1, 4), (2, 5), (3, 6)] #使用list()函数转换为列表
>>> list(zip(a,c))
[(1, 4), (2, 5), (3, 6)]
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
>>> a = [1,2,3]
>>> b = [4,5,6]
>>> c = [4,5,6,7,8]
>>> zipped = zip(a,b)
>>> list(zip(*zipped)) #解压也使用list进行转换
[(1, 2, 3), (4, 5, 6)]
>>> zipped = zip(a,b)
>>> x,y = zip(*zipped)
>>> print(x)
(1,2,3)
</code></pre>
                    </div>
                </section>
                <section>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
from itertools import groupby

def draw_line(x_data, y_data, title, y_legend):
    xy_map = []
    <mark>for x, y in groupby(sorted(zip(x_data, y_data)), key=lambda _: _[0]):</mark>  
        y_list = [v for _, v in y]
        xy_map.append([x, sum(y_list) / len(y_list)])  
    x_unique, y_mean = zip(*xy_map) # [*zip(*xy_map)] 
    line_chart = pygal.Line()
    line_chart.title = title
    line_chart.x_labels = x_unique
    line_chart.add(y_legend, y_mean)
    line_chart.render_to_file(title + '.svg')
    return line_chart
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
idx_month = dates.index('2017-12-01') #list.index()
line_chart_month = draw_line(
    months[:idx_month], close[:idx_month], '收盘价月日均值（¥）', '月日均值')
</code></pre>
                    </div>
                </section>
                <section>
                    <div class="fragment"><img data-src="close_price_avg.svg" style="height: 400pt"></div>
                </section>
            </section>
            <section>
                <section data-background="#2980b9" style="color: white">
                    <h2 style="color: white">12.2 API</h2>
                </section>
                <section>
                    <p>GitHub</p>
                    <p><a href="https://api.github.com/search/repositories?q=language:python&sort=stars">https://api.github.com/search/repositories?q=language:python&sort=stars</a></p>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
url = 'https://api.github.com/search/repositories?q=language:python&sort=stars'
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
import requests

# Make an API call and store the response.
r = requests.get(url)
print("Status code:", r.status_code)
# Store API response in a variable.
response_dict = r.json()

print(response_dict.keys())
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
Status code: 200
dict_keys(['total_count', 'incomplete_results', 'items'])
</code></pre>
                    </div>
                </section>
                <section>
                    <ul>
                        <li>Working with the Response Dictionary</li>
                    </ul>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
import requests
url = 'https://api.github.com/search/repositories?q=language:python&sort=stars'
# Make an API call and store the response.
r = requests.get(url)
print("Status code:", r.status_code)
# Store API response in a variable.
response_dict = r.json()
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
print("Total repositories:", response_dict['total_count'])
# Explore information about the repositories.
repo_dicts = response_dict['items']
print("Repositories returned:", len(repo_dicts))

# Examine the first repository.
repo_dict = repo_dicts[0]
print("\nKeys:", len(repo_dict))
for key in sorted(repo_dict.keys()):
    print(key)
</code></pre>
                    </div>
                </section>
                <section>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
print("\nSelected information about first repository:")
print('Name:', repo_dict['name'])
print('Owner:', repo_dict['owner']['login'])
print('Stars:', repo_dict['stargazers_count'])
print('Repository:', repo_dict['html_url'])
print('Created:', repo_dict['created_at'])
print('Updated:', repo_dict['updated_at'])
print('Description:', repo_dict['description'])
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
Status code: 200
Total repositories: 3675320
Repositories returned: 30

Selected information about first repository:
Name: public-apis
Owner: toddmotto
Stars: 57212
Repository: https://github.com/toddmotto/public-apis
Created: 2016-03-20T23:49:42Z
Updated: 2019-05-22T09:34:50Z
Description: A collective list of free APIs for use in software and web development.
</code></pre>
                    </div>
                </section>
                <section>
                    <ul>
                        <li>Visualizing Repositories Using Pygal</li>
                    </ul>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
import requests
import pygal
from pygal.style import LightColorizedStyle as LCS, LightenStyle as LS

URL = 'https://api.github.com/search/repositories?q=language:python&sort=star'
r = requests.get(URL)
print("Status code:", r.status_code)
response_dict = r.json()
print("Total repositories:", response_dict['total_count'])
repo_dicts = response_dict['items']
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
names, stars = [], []
for repo_dict in repo_dicts:
    names.append(repo_dict['name'])
    stars.append(repo_dict['stargazers_count'])
# Make visualization.
my_style = LS('#333366', base_style=LCS)
chart = pygal.Bar(style=my_style, x_label_rotation=45, show_legend=False)
chart.title = 'Most-Starred Python Projects on GitHub'
chart.x_labels = names

chart.add('', stars)
chart.render_to_file('python_repos.svg')
</code></pre>
                    </div>
                </section>
                <section>
                    <ul>
                        <li><a href="https://news.ycombinator.com/">Hacker News API</a></li>
                        <li><a href="https://hacker-news.firebaseio.com/v0/item/9884165.json">9884165</a></li>
                    </ul>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
{
"by":"nns",
"descendants":297,
"id":9884165,
"kids":[9885099,9884723,9885165,9884789,9885604,9884137,
9886151,9885220,9885790,9884661,9885844,9885029,9884817,
9887342,9884545,9884372,9884499,9884881,9884109,9886496,
9884342,9887832,9885023,9884334,9884707,9887008,9885348,
9885131,9887539,9885880,9884196,9884640,9886534,9885152],
"score":558,
"time":1436875181,
"title":"New Horizons: Nasa spacecraft speeds past Pluto",
"type":"story",
"url":"http://www.bbc.co.uk/news/science-environment-33524589"
}
</code></pre>
                    </div>
                </section>
                <section>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
import requests
from operator import itemgetter
# Make an API call and store the response.
url = 'https://hacker-news.firebaseio.com/v0/topstories.json'
r = requests.get(url)
print("Status code:", r.status_code)
# Process information about each submission.

submission_ids = r.json()
submission_dicts = []
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>

for submission_id in submission_ids[:5]:
# Make a separate API call for each submission.
    url = ('https://hacker-news.firebaseio.com/v0/item/' +
        str(submission_id) + '.json')
    submission_r = requests.get(url)
    print(submission_r.status_code)
    response_dict = submission_r.json()
    submission_dict = {
        'title': response_dict['title'],
        'link': 'http://news.ycombinator.com/item?id=' + str(submission_id),
        'comments': response_dict.get('descendants', 0)
        }
    submission_dicts.append(submission_dict)    
</code></pre>
                    </div>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
submission_dicts = sorted(submission_dicts, key=itemgetter('comments'),reverse=True)
for submission_dict in submission_dicts:
    print("\nTitle:", submission_dict['title'])
    print("Discussion link:", submission_dict['link'])
    print("Comments:", submission_dict['comments'])
</code></pre>
                    </div>
                </section>
                <section>
                    <ul>
                        <li>Where to find API?</li>
                        <li><a href="https://github.com/toddmotto/public-apis">Public APIs</a></li>
                    </ul>
                </section>
                <section>
                    <p>Working with APIs</p>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
import requests

url = "http://t.weather.sojson.com/api/weather/city/101020100"
r = requests.get(url)
print(r.status_code)

response_dict = r.json()
f = response_dict['data']
ff = f['forecast']
ff_today = ff[0]
ff_1 = ff[1]
ff_2 = ff[2]

def show(day):
    for x in day:
        print(x +': ' + str(day[x]))
    print('\n')
show(ff_today)
show(ff_1)
show(ff_2)
</code></pre>
                    </div>
                </section>
                <section>
                    <p><a href="http://www.tuling123.com/">Turing Robot</a></p>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
import requests     
    
KEY = '' # 这里填拿到的key    
    
def get_response(msg):    
    apiUrl = 'http://www.tuling123.com/openapi/api'    
    data = {    
        'key'    : KEY,    
        'info'   : msg,    
        'userid' : '路老师',    
    }    
    try:    
        r = requests.post(apiUrl, data=data).json()    
        return r.get('text')    
    except:    
        return None
print(get_response('你好'))
</code></pre>
                    </div>
                </section>
            </section>
            <section>
                <section data-background="#2980b9" style="color: white">
                    <h2 style="color: white">12.3 Wordcloud & Encoding</h2>
                </section>
                <section>
                    <div class="fragment"><img data-src="wordcloud_ex.png" style="height: 400pt"></div>
                </section>
                <section>
                    <div class="fragment">
                        <pre><code class="line-numbers" data-trim contenteditable data-noescape>
from matplotlib import pyplot as plt
from wordcloud import WordCloud
 
string = 'Importance of relative word frequencies for font-size. 
With relative_scaling=0, only word-ranks are considered. With 
relative_scaling=1, a word that is twice as frequent will have 
twice the size. If you want to consider the word frequencies 
and not only their rank, relative_scaling around .5 often looks good.'
font = r'C:\Windows\Fonts\Arial.TTF'
wc = WordCloud(font_path=font, #如果是中文必须要添加这个，否则会显示成框框
               background_color='white',
               width=1000,
               height=800,
               ).generate(string)
wc.to_file('ss.png') #保存图片
plt.imshow(wc)  #用plt显示图片
plt.axis('off') #不显示坐标轴
plt.show() #显示图片
</code></pre>
                    </div>
                </section>
                <section>
                    <h3>Character encoding Encoding</h3>
                    <ul>
                        <li>ASCII</li>
                        <li>Unicode</li>
                        <li>UTF-8</li>
                    </ul>
                </section>
                <section>
                    <ul>
                        <li>
                            <p>Python Crash Couse (Chapters we do not cover: Chapter 12 - 14, 18 - 20)</p>
                            <ul>
                                <li>
                                    <p>Chapter 12 -14: Alien Invasion</p>
                                </li>
                                <li>
                                    <p>Chapter 18 - 20: Django</p>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <p>Python for Everybody (Chapters we do not cover: Chapter 11 - 13, 15 - 16)</p>
                            <ul>
                                <li>
                                    <p>Chapter 11: Regualer Expressions</p>
                                </li>
                                <li>
                                    <p>Chapter 12: Networked Programs 12.4 - 12.8 (urlib, BeautifulSoup)</p>
                                </li>
                                <li>
                                    <p>Chapter 13: Using Web Services (XML, JSON, API)</p>
                                </li>
                                <li>
                                    <p>Chapter 15: Databases and SQL</p>
                                </li>
                                <li>
                                    <p>Chapter 16: Visualizing data (Network, Word Cloud)</p>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </section>
            </section>
            <section>
                <section data-background="#2c3e50" style="color: white; text-align: left;">
                    <h2 style="color: white">Summary</h2>
                    <ul>
                        <li>Downloading Data</li>
                        <li>API</li>
                        <li>Wordcloud</li>
                        <ul>
                            <li>Reading: Python Crash Course, Chapter 16, 17</li>
                        </ul>
                    </ul>
                </section>
            </section>
        </div>
    </div>
    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>
    <script>
    // More info about config & dependencies:
    // - https://github.com/hakimel/reveal.js#configuration
    // - https://github.com/hakimel/reveal.js#dependencies
    Reveal.initialize({
        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 960,
        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        // Bounds for smallest/largest possible scale to apply to content
        minScale: 0.2,
        maxScale: 1.5,

        // Display controls in the bottom right corner
        controls: true,

        // Display a presentation progress bar
        progress: true,

        // Set default timing of 2 minutes per slide
        defaultTiming: 120,

        // Display the page number of the current slide
        slideNumber: true,

        // Push each slide change to the browser history
        history: false,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Vertical centering of slides
        center: true,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autolaying embedded media (video/audio/iframe)
        // - null: Media will only autoplay if data-autoplay is present
        // - true: All media will autoplay, regardless of individual setting
        // - false: No media will autoplay, regardless of individual setting
        autoPlayMedia: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: Reveal.navigateNext,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // Hides the address bar on mobile devices
        hideAddressBar: true,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style
        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Transition speed
        transitionSpeed: 'default', // default/fast/slow

        // Transition style for full page slide backgrounds
        backgroundTransition: 'fade', // none/fade/slide/convex/concave/zoom

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Parallax background image
        parallaxBackgroundImage: '', // e.g. "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'"

        // Parallax background size
        parallaxBackgroundSize: '', // CSS syntax, e.g. "2100px 900px"

        // Number of pixels to move the parallax background per slide
        // - Calculated automatically unless specified
        // - Set to 0 to disable movement along an axis
        parallaxBackgroundHorizontal: null,
        parallaxBackgroundVertical: null,

        // The display mode that will be used to show slides
        display: 'block',

        dependencies: [
            { src: 'plugin/markdown/marked.js' },
            { src: 'plugin/markdown/markdown.js' },
            { src: 'plugin/notes/notes.js', async: true },
            { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
            // Zoom in and out with Alt+click
            { src: 'plugin/zoom-js/zoom.js', async: true },

            // Speaker notes
            { src: 'plugin/notes/notes.js', async: true },

            // MathJax
            { src: 'plugin/math/math.js', async: true },
            { src: 'plugin/line-numbers/line-numbers.js' }
        ]
    });
    </script>
</body>

</html>